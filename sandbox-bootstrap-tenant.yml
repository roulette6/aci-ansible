---
# This playbook is meant to be a simple bootstrap of an ACI sandbox
# once the fabric has been discovered. The playbook expects a small
# fabric with spine-201, leaf-201, and leaf-202. The playbook will
# create the following:

# TENANT:
# One tenant, VRF, BD, AP, and EPG. Static path bindings to
# all three interfaces.

# ansible-playbook sandbox-bootstrap-tenant.yml --extra-vars "apic=aci.vm.jm"

- name: "Create tenant components"
  hosts: "{{ apic }}"
  ignore_errors: true
  vars:
    login_info: &login_info
      host: "{{ inventory_hostname }}"
      username: "{{ ansible_user }}"
      password: "{{ ansible_password }}"
      validate_certs: false

  tasks:
    - name: "Create {{ tenant }} tenant"
      aci_tenant:
        <<: *login_info

        annotation: "orchestrator:ansible"
        tenant: "{{ tenant }}"
        description: "{{ descr }}"
        state: present
      delegate_to: localhost

    - name: "Create {{ vrf }} VRF"
      aci_vrf:
        <<: *login_info

        annotation: "orchestrator:ansible"
        tenant: "{{ tenant }}"
        vrf: "{{ vrf }}"
        description: "{{ descr }}"
        state: present
      delegate_to: localhost

    - name: "Create {{ bd.name }} bridge domain"
      aci_bd:
        <<: *login_info

        annotation: "orchestrator:ansible"
        tenant: "{{ tenant }}"
        vrf: "{{ vrf }}"
        bd: "{{ bd.name }}"
        mac_address: "{{ bd.mac_addr }}"
        description: "{{ descr }}"
        state: present
      delegate_to: localhost

    - name: "Create {{ ap }} application profile"
      aci_ap:
        <<: *login_info

        annotation: "orchestrator:ansible"
        tenant: "{{ tenant }}"
        ap: "{{ ap }}"
        description: "{{ descr }}"
        state: present
      delegate_to: localhost

    - name: "Create {{ epg }} end point group"
      aci_epg:
        <<: *login_info

        annotation: "orchestrator:ansible"
        tenant: "{{ tenant }}"
        bd: "{{ bd.name }}"
        ap: "{{ ap }}"
        epg: "{{ epg }}"
        description: "{{ descr }}"
        state: present
      delegate_to: localhost

    - name: "Bind {{ epg }} to {{ domain }}"
      aci_epg_to_domain:
        <<: *login_info

        annotation: "orchestrator:ansible"
        tenant: "{{ tenant }}"
        ap: "{{ ap }}"
        epg: "{{ epg }}"
        domain: "{{ domain }}"
        domain_type: "{{ domain_type }}"
        state: present
      delegate_to: localhost

    - name: "Create static path bindings for {{ epg }}"
      aci_static_binding_to_epg:
        <<: *login_info

        annotation: "orchestrator:ansible"
        tenant: "{{ tenant }}"
        ap: "{{ ap }}"
        epg: "{{ epg }}"
        pod_id: "{{ static_paths.pod_id }}"
        leafs: "{{ item.leafs }}"
        interface_type: "{{ item.intf_type }}"
        interface_mode: "{{ item.intf_mode }}"
        interface: "{{ item.intf }}"
        encap_id: "{{ static_paths.encap_id }}"
        deploy_immediacy: "{{ static_paths.immediacy }}"
        state: present
      delegate_to: localhost
      with_items: "{{ static_paths.paths }}"
